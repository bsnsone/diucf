<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handles Data</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .no-data {
            text-align: center;
            color: #777;
            padding: 20px;
        }
        .error {
            color: #d9534f;
            text-align: center;
            padding: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .load-button {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .load-button:hover {
            background-color: #218838;
        }
        .load-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100px;
        }
        .log {
            font-size: 14px;
            margin-top: 5px;
            text-align: center;
        }
        .log-success {
            color: #28a745;
        }
        .log-existing {
            color: #777;
        }
        .log-skipped {
            color: #d9534f;
        }
        .log-processing {
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <input type="number" id="contestCount" class="load-input" value="15" min="1" placeholder="Number of contests">
            <button class="load-button" id="loadButton">Load</button>
        </div>
        <div id="loadLogs"></div>
        <h1>Handles and Contests Data</h1>
        <h2>Handles</h2>
        <div id="handlesTable"></div>
        <h2>Contests</h2>
        <div id="contestsTable"></div>
    </div>

    <script type="module">
        import { fetchHandlesFromDB } from './js/script.js';

        // Supabase configuration (same as script.js)
        const supabaseUrl = "https://yvcxjijotyiyvwhcgcrh.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2Y3hqaWpvdHlpeXZ3aGNnY3JoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0ODk0OTAsImV4cCI6MjA2MjA2NTQ5MH0.Xk16aqTZZyiNUoFYmXgb6PauNxTZ-PwrOfH-6bvzl-U";

        // Check if a contest exists in the database
        async function contestExists(contestId) {
            try {
                const res = await fetch(`${supabaseUrl}/rest/v1/contests?id=eq.${contestId}`, {
                    headers: {
                        apikey: supabaseKey,
                        Authorization: `Bearer ${supabaseKey}`,
                    }
                });
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                const data = await res.json();
                return data.length > 0;
            } catch (err) {
                console.error("Error checking contest existence:", err);
                throw err;
            }
        }

        // Check if a contest has associated handles
        async function hasHandles(contestId) {
            try {
                const handles = await fetchHandlesFromDB();
                const res = await fetch(`${supabaseUrl}/rest/v1/contest_ratings?contest_id=eq.${contestId}&select=rating_data`, {
                    headers: {
                        apikey: supabaseKey,
                        Authorization: `Bearer ${supabaseKey}`,
                    }
                });
                if (!res.ok) return false;
                const data = await res.json();
                return data.length > 0 && data[0]?.rating_data?.some(entry => handles.includes(entry.handle)) || false;
            } catch (err) {
                console.error("Error checking handles:", err);
                return false;
            }
        }

        // Insert a new contest into the database
        async function insertContest(contest) {
            try {
                const res = await fetch(`${supabaseUrl}/rest/v1/contests`, {
                    method: "POST",
                    headers: {
                        apikey: supabaseKey,
                        Authorization: `Bearer ${supabaseKey}`,
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        id: contest.id,
                        name: contest.name,
                        date: new Date(contest.startTimeSeconds * 1000).toISOString(),
                    })
                });
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
            } catch (err) {
                console.error("Error inserting contest:", err);
                throw err;
            }
        }

        // Fetch contests from Codeforces API
        async function fetchExternalContests(limit) {
            try {
                const res = await fetch("https://codeforces.com/api/contest.list?gym=false");
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                const data = await res.json();
                if (data.status !== "OK") {
                    throw new Error("Failed to fetch contest list");
                }
                return data.result
                    .filter(c => c.phase === "FINISHED")
                    .slice(0, limit)
                    .map(c => ({
                        id: c.id,
                        name: c.name,
                        startTimeSeconds: c.startTimeSeconds
                    }));
            } catch (err) {
                console.error("Failed to fetch contests:", err);
                throw err;
            }
        }

        // Load latest contests
        async function loadLatestContests() {
            const tableDiv = document.getElementById("contestsTable");
            const logDiv = document.getElementById("loadLogs");
            const countInput = document.getElementById("contestCount");
            const limit = parseInt(countInput.value) || 15;

            logDiv.innerHTML = '<p class="log log-processing">Processing...</p>';

            try {
                const externalContests = await fetchExternalContests(limit);
                const logs = [];
                let newContestCount = 0;

                logDiv.innerHTML = '';

                for (const contest of externalContests) {
                    const exists = await contestExists(contest.id);
                    if (exists) {
                        logs.push(`<p class="log log-existing">Contest ${contest.id} (${contest.name}) already loaded.</p>`);
                        continue;
                    }

                    const hasUsers = await hasHandles(contest.id);
                    if (!hasUsers) {
                        logs.push(`<p class="log log-skipped">Contest ${contest.id} (${contest.name}) skipped: no associated handles.</p>`);
                        continue;
                    }

                    await insertContest(contest);
                    logs.push(`<p class="log log-success">Contest ${contest.id} (${contest.name}) successfully imported.</p>`);
                    newContestCount++;
                }

                const res = await fetch(`${supabaseUrl}/rest/v1/contests?select=id,name,date&order=date.desc&limit=${limit}`, {
                    headers: {
                        apikey: supabaseKey,
                        Authorization: `Bearer ${supabaseKey}`,
                    }
                });
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                const contests = await res.json();

                if (contests.length === 0) {
                    tableDiv.innerHTML = '<p class="no-data">No contests found in the database.</p>';
                    logDiv.innerHTML = logs.join('') + `<p class="log">No contests loaded.</p>`;
                } else {
                    let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Date</th></tr></thead><tbody>';
                    contests.forEach(contest => {
                        html += `<tr><td>${contest.id}</td><td>${contest.name}</td><td>${new Date(contest.date).toLocaleDateString()}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    tableDiv.innerHTML = html;
                    logDiv.innerHTML = logs.join('') + `<p class="log log-success">Loaded ${contests.length} contests (${newContestCount} new).</p>`;
                }
            } catch (error) {
                console.error("Error loading contests:", error);
                logDiv.innerHTML = '<p class="error">Error loading contests: ' + error.message + '</p>';
                tableDiv.innerHTML = '<p class="error">Error loading contests. Please try again later.</p>';
            }
        }

        // Load handles table
        async function loadHandles() {
            const tableDiv = document.getElementById("handlesTable");
            try {
                const handles = await fetchHandlesFromDB();
                if (handles.length === 0) {
                    tableDiv.innerHTML = '<p class="no-data">No handles found in the database.</p>';
                    return;
                }

                let html = '<table><thead><tr><th>Handle</th></tr></thead><tbody>';
                handles.forEach(handle => {
                    html += `<tr><td>${handle}</td></tr>`;
                });
                html += '</tbody></table>';
                tableDiv.innerHTML = html;
            } catch (error) {
                console.error("Error loading handles:", error);
                tableDiv.innerHTML = '<p class="error">Error loading handles: ' + error.message + '</p>';
            }
        }

        // Initialize
        window.onload = loadHandles;
        document.getElementById("loadButton").addEventListener("click", loadLatestContests);
    </script>
</body>
</html>
